---
# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åå‰
name: JSONãƒ‡ãƒ¼ã‚¿æ›´æ–° (Workload Identityé€£æº)
on:
  schedule:
    # æ—¥æœ¬æ™‚é–“åˆå‰9æ™‚ã«æ¯æ—¥å®Ÿè¡Œ (UTCã®åˆå‰0æ™‚)
    - cron: 0 0 * * *
  # GitHubã®UIã‹ã‚‰æ‰‹å‹•ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  workflow_dispatch:
jobs:
  update-and-release:
    runs-on: ubuntu-latest
    # ã‚¸ãƒ§ãƒ–ã«ä¸ãˆã‚‹æ¨©é™
    permissions:
      # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ã‚³ãƒŸãƒƒãƒˆã€ãƒªãƒªãƒ¼ã‚¹ä½œæˆã®ãŸã‚ã«å¿…è¦
      contents: write
      # Workload Identityé€£æºã«ã‚ˆã‚‹Google Cloudã¸ã®èªè¨¼ã®ãŸã‚ã«å¿…è¦
      id-token: write
    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãƒ–ãƒ©ãƒ³ãƒ(master)ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹
      - name: 1. ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”¨ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ (master)
        uses: actions/checkout@v4
        with:
          ref: master
          # 'main_repo'ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹
          path: main_repo

      # ã‚¹ãƒ†ãƒƒãƒ—2: Workload Identityé€£æºã‚’ä½¿ç”¨ã—ã¦Google Cloudã¸èªè¨¼ã™ã‚‹
      - name: 2. Google Cloudã¸èªè¨¼
        uses: google-github-actions/auth@v2
        with:
          # GitHub Secretsã«è¨­å®šã—ãŸå€¤ã‚’å‚ç…§ã™ã‚‹
          workload_identity_provider: >-
            ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # ã‚¹ãƒ†ãƒƒãƒ—3: Pythonã®å®Ÿè¡Œç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
      - name: 3. Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # ã‚¹ãƒ†ãƒƒãƒ—4: Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã«å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
      - name: 4. ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth-httplib2 google-auth

        # ã‚¹ãƒ†ãƒƒãƒ—5: Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹
      - name: 5. Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦JSONã‚’ç”Ÿæˆ
        id: generate_json
        working-directory: ./main_repo
        run: |
          python sheet_to_json.py
          if [ -f imas_music_db.json ]; then
            echo "JSON_EXISTS=true" >> $GITHUB_OUTPUT
            echo "json_file_path=$(pwd)/imas_music_db.json" >> $GITHUB_OUTPUT
            echo "âœ… JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚"
          else
            echo "JSON_EXISTS=false" >> $GITHUB_OUTPUT
            echo "âŒ ã‚¨ãƒ©ãƒ¼: JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"
            exit 1
          fi

      # ã‚¹ãƒ†ãƒƒãƒ—6: Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
      - name: 6. Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        if: steps.generate_json.outputs.JSON_EXISTS == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # LTSç‰ˆã®Node.jsã‚’ä½¿ç”¨

      # ã‚¹ãƒ†ãƒƒãƒ—7: Prettierã§JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹
      - name: 7. Prettierã§JSONã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        if: steps.generate_json.outputs.JSON_EXISTS == 'true'
        run: |
          npm install -g prettier
          prettier --write ${{ steps.generate_json.outputs.json_file_path }}
          echo "ğŸ’… JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒPrettierã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚"

      # ã‚¹ãƒ†ãƒƒãƒ—8: ç”Ÿæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒ(data)ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹
      - name: 8. ãƒ‡ãƒ¼ã‚¿ã‚³ãƒŸãƒƒãƒˆç”¨ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ (data)
        if: steps.generate_json.outputs.JSON_EXISTS == 'true'
        uses: actions/checkout@v4
        with:
          ref: data
          path: data_repo

      # ã‚¹ãƒ†ãƒƒãƒ—9: ãƒ‡ãƒ¼ã‚¿ã®å·®åˆ†ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
      - name: 9. å·®åˆ†ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
        if: steps.generate_json.outputs.JSON_EXISTS == 'true'
        id: commit_push
        run: |
          # å¾Œç¶šã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãŸã‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºåŠ›ã‚’è¨­å®š
          echo "committed=false" >> $GITHUB_OUTPUT

          # ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ¼ã‚¿ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
          cp ${{ steps.generate_json.outputs.json_file_path }} \
            ./data_repo/imas_music_db.json

          # ãƒ‡ãƒ¼ã‚¿ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
          cd ./data_repo

          # Gitã®ã‚³ãƒŸãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨­å®š
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
          if [ -n "$(git status --porcelain imas_music_db.json)" ]; then
            echo "ğŸ”„ imas_music_db.json ã«å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚"
            git add imas_music_db.json

            # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¿ã‚°åç”¨ã®æ—¥ä»˜ã‚’ç”Ÿæˆ (JST)
            COMMIT_DATE_JST=$(TZ=Asia/Tokyo date +'%Y-%m-%d %H:%M:%S')
            TAG_NAME=$(TZ=Asia/Tokyo date +'%Y%m%d-%H%M%S')
            git commit -m "ğŸ“Š ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°: ${COMMIT_DATE_JST} (JST)"
            git push origin data
            echo "âœ… dataãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸã€‚"

            # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã®ãŸã‚ã«å‡ºåŠ›ã‚’æ›´æ–°
            echo "committed=true" >> $GITHUB_OUTPUT
            echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          else
            echo "âœ… imas_music_db.json ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
          fi

      # ã‚¹ãƒ†ãƒƒãƒ—10: æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
      - name: 10. ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
        if: steps.commit_push.outputs.committed == 'true'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.commit_push.outputs.tag_name }}
          release_name: ãƒ‡ãƒ¼ã‚¿æ›´æ–° (${{ steps.commit_push.outputs.tag_name }})
          body: |
            ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®è‡ªå‹•ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã§ã™ã€‚
          draft: false
          prerelease: false
          # dataãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
          commitish: data

      # ã‚¹ãƒ†ãƒƒãƒ—11: ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒªãƒ¼ã‚¹ã«æ·»ä»˜ã™ã‚‹
      - name: 11. ãƒªãƒªãƒ¼ã‚¹ã‚¢ã‚»ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: steps.commit_push.outputs.committed == 'true'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./data_repo/imas_music_db.json
          asset_name: imas_music_db.json
          asset_content_type: application/json
