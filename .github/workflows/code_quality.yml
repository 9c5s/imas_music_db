---
# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åå‰
name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹
on:
  pull_request:
    types: [opened, synchronize, reopened]
    # Pythonã¾ãŸã¯YAMLãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    paths:
      - '**.py'
      - '**.yml'
      - '**.yaml'
      - pyproject.toml
      - ruff.toml
      - .yamllint.yml
      - .yamlfix.toml
      - .github/workflows/code_quality.yml
jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    # PRã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ãŸã‚ã®æ¨©é™
    permissions:
      contents: read
      pull-requests: write
    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # ã‚¹ãƒ†ãƒƒãƒ—2: Pythonã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: 2. Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # ã‚¹ãƒ†ãƒƒãƒ—3: uvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆé«˜é€ŸãªPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰
      - name: 3. uvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: pyproject.toml

      # ã‚¹ãƒ†ãƒƒãƒ—4: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆé–‹ç™ºä¾å­˜é–¢ä¿‚ã‚’å«ã‚€ï¼‰
      - name: 4. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync

      # ã‚¹ãƒ†ãƒƒãƒ—5: YAMLãƒã‚§ãƒƒã‚¯ã®å®Ÿè¡Œ
      - name: 5. YAMLãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        id: yaml_check
        run: |
          # YAMLãƒã‚§ãƒƒã‚¯ã®çµæœã‚’ä¿å­˜
          echo "## ğŸ“„ YAMLã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯çµæœ" > yaml_report.md
          echo "" >> yaml_report.md

          # yamllintãƒã‚§ãƒƒã‚¯
          echo "### yamllintçµæœ" >> yaml_report.md
          if uv run yamllint . > yaml_lint_output.txt 2>&1; then
            echo "âœ… yamllint: ã‚¨ãƒ©ãƒ¼ãªã—" >> yaml_report.md
            YAML_LINT_STATUS=0
          else
            echo "âŒ yamllint: ã‚¨ãƒ©ãƒ¼ã‚ã‚Š" >> yaml_report.md
            echo '```' >> yaml_report.md
            cat yaml_lint_output.txt >> yaml_report.md
            echo '```' >> yaml_report.md
            YAML_LINT_STATUS=1
          fi
          echo "" >> yaml_report.md

          # ä¿®æ­£æ–¹æ³•
          if [ $YAML_LINT_STATUS -ne 0 ]; then
            echo "### ğŸ’¡ YAMLä¿®æ­£æ–¹æ³•" >> yaml_report.md
            echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š" >> yaml_report.md
            echo '```bash' >> yaml_report.md
            echo "# YAMLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®è‡ªå‹•ä¿®æ­£" >> yaml_report.md
            echo "uv run yamlfix ." >> yaml_report.md
            echo "" >> yaml_report.md
            echo "# yamllintãƒã‚§ãƒƒã‚¯" >> yaml_report.md
            echo "uv run yamllint ." >> yaml_report.md
            echo '```' >> yaml_report.md
          fi

          # çµæœã‚’å‡ºåŠ›ã«ä¿å­˜
          echo "YAML_LINT_STATUS=$YAML_LINT_STATUS" >> $GITHUB_OUTPUT
        continue-on-error: true

      # ã‚¹ãƒ†ãƒƒãƒ—6: Ruffãƒã‚§ãƒƒã‚¯ã®å®Ÿè¡Œã¨çµæœã®ä¿å­˜
      - name: 6. Ruffãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        id: ruff_check
        run: |
          # Ruffãƒã‚§ãƒƒã‚¯ã®çµæœã‚’ä¿å­˜
          echo "## ğŸ” Ruffã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯çµæœ" > ruff_report.md
          echo "" >> ruff_report.md

          # ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°
          echo "### ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°çµæœ" >> ruff_report.md
          if uv run ruff check \
            > ruff_lint_output.txt 2>&1; then
            echo "âœ… ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°: ã‚¨ãƒ©ãƒ¼ãªã—" >> ruff_report.md
            LINT_STATUS=0
          else
            echo "âŒ ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°: ã‚¨ãƒ©ãƒ¼ã‚ã‚Š" >> ruff_report.md
            echo '```' >> ruff_report.md
            cat ruff_lint_output.txt >> ruff_report.md
            echo '```' >> ruff_report.md
            LINT_STATUS=1
          fi
          echo "" >> ruff_report.md

          # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
          echo "### ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯çµæœ" >> ruff_report.md
          if uv run ruff format --check --diff \
            > ruff_format_output.txt 2>&1; then
            echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: å•é¡Œãªã—" >> ruff_report.md
            FORMAT_STATUS=0
          else
            echo "âŒ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ä¿®æ­£ãŒå¿…è¦" >> ruff_report.md
            echo '```diff' >> ruff_report.md
            cat ruff_format_output.txt >> ruff_report.md
            echo '```' >> ruff_report.md
            FORMAT_STATUS=1
          fi
          echo "" >> ruff_report.md

          # çµ±è¨ˆæƒ…å ±
          echo "### çµ±è¨ˆæƒ…å ±" >> ruff_report.md
          echo '```' >> ruff_report.md
          uv run ruff check --statistics >> ruff_report.md 2>&1 || true
          echo '```' >> ruff_report.md
          echo "" >> ruff_report.md

          # ä¿®æ­£æ–¹æ³•
          if [ $LINT_STATUS -ne 0 ] || [ $FORMAT_STATUS -ne 0 ]; then
            echo "### ğŸ’¡ Pythonä¿®æ­£æ–¹æ³•" >> ruff_report.md
            echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š" >> ruff_report.md
            echo '```bash' >> ruff_report.md
            if [ $LINT_STATUS -ne 0 ]; then
              echo "# ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã®è‡ªå‹•ä¿®æ­£" >> ruff_report.md
              echo "uv run ruff check --fix" >> ruff_report.md
            fi
            if [ $FORMAT_STATUS -ne 0 ]; then
              echo "# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®è‡ªå‹•ä¿®æ­£" >> ruff_report.md
              echo "uv run ruff format" >> ruff_report.md
            fi
            echo '```' >> ruff_report.md
          fi

          # çµæœã‚’å‡ºåŠ›ã«ä¿å­˜
          echo "LINT_STATUS=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "FORMAT_STATUS=$FORMAT_STATUS" >> $GITHUB_OUTPUT
        continue-on-error: true

      # ã‚¹ãƒ†ãƒƒãƒ—7: ãƒ¬ãƒãƒ¼ãƒˆã‚’çµ±åˆ
      - name: 7. ãƒ¬ãƒãƒ¼ãƒˆçµ±åˆ
        run: |
          # YAMLã¨Ruffã®ãƒ¬ãƒãƒ¼ãƒˆã‚’çµ±åˆ
          cat yaml_report.md > combined_report.md
          echo "" >> combined_report.md
          cat ruff_report.md >> combined_report.md

      # ã‚¹ãƒ†ãƒƒãƒ—8: PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
      - name: 8. PR ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
        uses: thollander/actions-comment-pull-request@v3
        with:
          file-path: combined_report.md
          comment-tag: code_quality_check
          mode: recreate

      # ã‚¹ãƒ†ãƒƒãƒ—9: GitHubå½¢å¼ã§ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
      - name: 9. GitHubå½¢å¼ã§ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        run: |
          # GitHubå½¢å¼ã§å†åº¦å®Ÿè¡Œï¼ˆActions UIã§ã®è¦–èªæ€§å‘ä¸Šã®ãŸã‚ï¼‰
          echo "=== yamllint GitHubå½¢å¼å‡ºåŠ› ==="
          uv run yamllint --format github . 2>&1 || true
          echo "=== Ruff GitHubå½¢å¼å‡ºåŠ› ==="
          uv run ruff check --output-format=github . 2>&1 || true

      # ã‚¹ãƒ†ãƒƒãƒ—10: å¤±æ•—åˆ¤å®š
      - name: 10. ãƒã‚§ãƒƒã‚¯çµæœã®åˆ¤å®š
        if: >-
          steps.yaml_check.outputs.YAML_LINT_STATUS != '0' ||
          steps.ruff_check.outputs.LINT_STATUS != '0' ||
          steps.ruff_check.outputs.FORMAT_STATUS != '0'
        run: |-
          echo "âŒ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚"
          echo "è©³ç´°ã¯PRã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          exit 1
